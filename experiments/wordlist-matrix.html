<!doctype html>
<html>
    <head>
        <title>Coglab Experiment</title>
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script> -->
        <script src="../jsPsych-4.3/jquery.min.js"></script>
        <script src="../jsPsych-4.3/jspsych.js"></script>
        <script src="../jsPsych-4.3/plugins/jspsych-text.js"></script>
        <script src="../jsPsych-4.3/plugins/jspsych-single-stim-ao.js"></script>
        <script src="../jsPsych-4.3/plugins/jspsych-single-stim.js"></script>
        <script src="../jsPsych-4.3/plugins/jspsych-wordlist.js"></script>
        <script src="../jsPsych-4.3/plugins/jspsych-fullscreen.js"></script>
        <script src="../jsPsych-4.3/plugins/jspsych-response-table.js"></script>
        <script src="../jsPsych-4.3/plugins/jspsych-save-get-vars.js"></script>
        <script src="./words.js"></script>
        <link href="../jsPsych-4.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    </head>
    <body>
    </body>
    <script>
      // settings
      var url = document.location.toString();
      var experiment_name =  url.split('/')[url.split('/').length-1].split('.')[0];
      var getVars = jsPsych.data.fromURL();
      var uniqueId = jsPsych.data.uniqueId();
      var screen_width = screen.width;
      var screen_height = screen.height;
      var centerX = screen_width*0.5
      var centerY = screen_height*0.5

      jsPsych.data.addProperties(getVars);
      jsPsych.data.addProperties({
        experiment_name: experiment_name,
        uniqueId: uniqueId
      });

      // prepare structures
      var activate_fullscreen = {
          type: 'fullscreen',
          showtext: '<p style="padding-top: 50px; text-align: center;">Welcome <br><br> Please continue to enter into full screen mode.<br><br>',
          buttonStyle : 'float:right;',
          buttontext: "Enter",
          on_fullscreen_abort: function(){
            // jAlert('','Fullscreen Failure')
            errStyle = "color:red;margin-top:200px;text-align:center;font-weight:bold;";
            string = "<p style='"+errStyle+"'>You were not supposed to end fullscreen mode. <br>The session was terminated.</p>";
            jsPsych.finishTrial();
            jsPsych.endExperiment(string);
        },
          on_hide_abort:function(){
            // jAlert('','Visibility Failure')
            errStyle = "color:red;margin-top:200px;text-align:center;font-weight:bold;";
            string = "<p style='"+errStyle+"'>You were not supposed to switch tabs or applications during the experiment.<br>The session was terminated.</p>";
            jsPsych.finishTrial();
            jsPsych.endExperiment(string);
          },
          on_launch_fail: function(){
            jsPsych.finishTrial();
            errStyle = "margin-top:200px;text-align:center;font-weight:bold;";
            string = "<p style='"+errStyle+"'>Your Browser doesn't allow launching into fullscreen. Please update your Browser or use another one for this experiment. We recommend using Chrome or Firefox.</p>";
            jsPsych.endExperiment(string);
          },
          on_hide_fail:function(){
            jsPsych.finishTrial();
            errStyle = "margin-top:200px;text-align:center;font-weight:bold;";
            string = "<p style='"+errStyle+"'>Your Browser doesn't allow checking the browser's visibility. Please update your browser or use another one for this experiment. We recommend using Chrome or Firefox.</p>";
            jsPsych.endExperiment(string);
          }
      }

      /* define instructions block */
      var instructions_block = {
        type: "text",
        text: "<p style='margin-top:200px;text-align:center;'>Instructions.<br><br> Press any key to continue.</p>",
        timing_response: -1
      };

      function getCrossTable(linelength){
            var table = "<table style='margin:0 auto;border-collapse:collapse;position:relative;top:"+(screen.height*.5-linelength).toString()+"px;'>"
            var tdStyles =
                ["height:"+linelength+"px;width:"+linelength+"px;border-right:4px solid black;border-bottom:4px solid black;",
                 "height:"+linelength+"px;width:"+linelength+"px;border-left:4px solid black;border-bottom:4px solid black;",
                 "height:"+linelength+"px;width:"+linelength+"px;border-right:4px solid black;border-top:4px solid black;",
                 "height:"+linelength+"px;width:"+linelength+"px;border-left:4px solid black;border-top:4px solid black;"]
            for (i=0;i<2;i++){
              table += "<tr>"
              for(j=0;j<2;j++){
                idx = (i*2)+(j)
                table += "<td style='"+tdStyles[idx]+"'/>"
              }
              table += "</tr>"
            }
            table += "</table"
            return table
        }

      var cross_block = {
            type: 'single-stim-ao',
            stimuli: getCrossTable(100),
            timing_post_trial: 0,
            timing_response: 500,
            response_ends_trial: false
        }

      var empty_block = {
            type: 'single-stim',
            stimuli: '',
            timing_post_trial: 0,
            timing_response: 2000,
            response_ends_trial: false
        }

      function getRandomWordlistSample(N,option){
          sample = jsPsych.randomization.sample(wordlistItems,N,true)
          if(typeof option === "undefined") {
            return sample
          }else{
            newSample = []
            for(i=0;i<N;i++){
              newSample.push(sample[i][option])
            }
            return newSample
          }
        }
      var items_func = function(){return getRandomWordlistSample(10)};
      var colors_func = function(){return jsPsych.randomization.repeat(['red','blue'],5)};

      var word_presentation = {
            type: 'wordlist',
            items: items_func,
            colors: colors_func,
            style: "position:relative;top:"+(centerY-50).toString()+"px;text-align:center;"+
                          "font-weight:bold;font-size:100px;",
            timing_stim: 2000,
            timing_response: 2500,
            timing_post_trial: 0,
            response_ends_trial: true,
            evaluate_block: true
        }

      function getPreviousTenWords(){
        lastTrials = jsPsych.data.getTrialsOfType('wordlist')
        keys = Object.keys(lastTrials[0])
        if (keys.indexOf('text') == -1){
          return
        }
        lastTenTrials = lastTrials.slice(lastTrials.length-10,lastTrials.length)
        lastTenTrialsTexts = []
        for (i=0;i<10;i++){
          lastTenTrialsTexts.push(lastTenTrials[i].text)
        }
        return lastTenTrialsTexts
      }

      function sameElementInArrays(array1,array2){
        b = false
        for (i=0;i<array1.length;i++){
          if ( array2.indexOf(array1[i]) > -1){
            b = true
            break
          }
        }
        return(b)
      };

      var response_words = function getResponseSet(wordlistItems){
          var preWords = getPreviousTenWords();
          if (typeof preWords =="undefined"){
            preWords = getRandomWordlistSample(1,'text')
          }
          while(true){
            newSample = getRandomWordlistSample(5,'text');
            if(!sameElementInArrays(newSample,preWords)){
              break;
            }
          }
          var sample = preWords.concat(newSample);
          var sample = sample.sort(function() { return(0.5-Math.random())});
          return sample;
      }

      var response_table = {
        type : "response-table",
        words : response_words,
        rows : 3,
        cols : 5,
        tdStyle : "height:80px;width:150px;font-size:25px;padding:15px;text-align:center;",
        tableStyle: "position:relative;margin: 0 auto; top:"+(centerY-150).toString()+"px;"
      }

      var end_fullscreen = {
          type: 'fullscreen',
          showtext: '<p style="padding-top: 50px; text-align: center;">Thank you for participating!<br><br> Please save your responses before you close the window.',
          buttonStyle : 'float:right;',
          buttontext: "Save & Exit",
          exit: true
      }

        var save_get_block = {
            type: 'save-get-vars',
            all: true
          }

        var chunkIdx=0;
        var chunk = {
            chunk_type: 'while',
            timeline: [cross_block, word_presentation, response_table, empty_block],
            // timeline: [ word_presentation, response_table],
            continue_function: function(){
            if (chunkIdx==2){
              return false
            }else{
              chunkIdx+=1
              return true
            }
          }
        };

        /* create experiment definition array */
        var experiment = [];
        experiment.push(activate_fullscreen);
        experiment.push(instructions_block);
        experiment.push(chunk);
        experiment.push(end_fullscreen);

        //create default display element and style classes
        var fsDiv = "<div id='fsDiv' style='text-algin:center;position:absolute;height:"+screen_height.toString()+"px;width:"+screen_width.toString()+"px;'></div>";
        $('body').append(fsDiv)

        function saveData(subjectID,experiment_name,csvStrings,dataAsJSON){
         $.ajax({
            type: 'post',
            cache: false,
            url: '../store2.php', // this is the path to the above PHP script
            data: {subjectID: subjectID, folder: experiment_name, csvStrings: csvStrings, dataAsJSON:dataAsJSON}
         });
        }

        function getCsvStrings(){
          csvStrings = [];
          csvStrings.push(jsPsych.data.dataOfTypeAsCSV('wordlist'));
          csvStrings.push(jsPsych.data.dataOfTypeAsCSV('response-table'));
          return csvStrings
        }

        /* start the experiment */
        jsPsych.init({
          display_element: $('#fsDiv'),
          experiment_structure: experiment,
          on_finish: function(data){
            saveData(uniqueId,experiment_name, getCsvStrings(data), jsPsych.data.dataAsJSON())
          }
        });
      </script>
</html>
